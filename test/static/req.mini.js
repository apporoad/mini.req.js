!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){var e=exports="undefined"==typeof window,t=null;if(e){var r=require("path"),n=require("http"),o=require("https"),s=require("querystring"),i=require("zlib"),a=require("url").URL,u=["gzip","deflate"],c=function(){function e(e,t){this.coreRes=e,this.resOptions=t,this.body=Buffer.alloc(0),this.headers=e.headers,this.statusCode=e.statusCode}var t=e.prototype;return t._addChunk=function(e){this.body=Buffer.concat([this.body,e])},t.json=function(){try{return Promise.resolve(204===this.statusCode?null:JSON.parse(this.body))}catch(e){return Promise.reject(e)}},t.text=function(){try{return Promise.resolve(this.body.toString())}catch(e){return Promise.reject(e)}},e}();t=function(){function e(e,t){return void 0===t&&(t="GET"),this.url="string"==typeof e?new a(e):e,this.method=t,this.data=null,this.sendDataAs=null,this.reqHeaders={},this.streamEnabled=!1,this.compressionEnabled=!1,this.timeoutTime=null,this.coreOptions={},this.resOptions={maxBuffer:99995e3},this}var t=e.prototype;return t.query=function(e,t){var r=this;return"object"==typeof e?Object.keys(e).forEach(function(t){r.url.searchParams.append(t,e[t])}):this.url.searchParams.append(e,t),this},t.path=function(e){return this.url.pathname=r.join(this.url.pathname,e),this},t.body=function(e,t){return this.sendDataAs="object"!=typeof e||t||Buffer.isBuffer(e)?t?t.toLowerCase():"buffer":"json",this.data="form"===this.sendDataAs?s.stringify(e):"json"===this.sendDataAs?JSON.stringify(e):e,this},t.header=function(e,t){var r=this;return"object"==typeof e?Object.keys(e).forEach(function(t){r.reqHeaders[t.toLowerCase()]=e[t]}):this.reqHeaders[e.toLowerCase()]=t,this},t.timeout=function(e){return this.timeoutTime=e,this},t.option=function(e,t){return this.coreOptions[e]=t,this},t.stream=function(){return this.streamEnabled=!0,this},t.compress=function(){return this.compressionEnabled=!0,this.reqHeaders["accept-encoding"]||(this.reqHeaders["accept-encoding"]=u.join(", ")),this},t.send=function(){var e=this;return new Promise(function(t,r){e.data&&(e.reqHeaders.hasOwnProperty("content-type")||("json"===e.sendDataAs?e.reqHeaders["content-type"]="application/json":"form"===e.sendDataAs&&(e.reqHeaders["content-type"]="application/x-www-form-urlencoded")),e.reqHeaders.hasOwnProperty("content-length")||(e.reqHeaders["content-length"]=Buffer.byteLength(e.data)));var s,a=Object.assign({protocol:e.url.protocol,host:e.url.hostname,port:e.url.port,path:e.url.pathname+(null===e.url.search?"":e.url.search),method:e.method,headers:e.reqHeaders},e.coreOptions),u=function(n){var o,s=n;e.compressionEnabled&&("gzip"===n.headers["content-encoding"]?s=n.pipe(i.createGunzip()):"deflate"===n.headers["content-encoding"]&&(s=n.pipe(i.createInflate()))),e.streamEnabled?t(s):(o=new c(n,e.resOptions),s.on("error",function(e){r(e)}),s.on("data",function(t){o._addChunk(t),null!==e.resOptions.maxBuffer&&o.body.length>e.resOptions.maxBuffer&&(s.destroy(),r("Received a response which was longer than acceptable when buffering. ("+e.body.length+" bytes)"))}),s.on("end",function(){t(o)}))};if("http:"===e.url.protocol)s=n.request(a,u);else{if("https:"!==e.url.protocol)throw new Error("Bad URL protocol: "+e.url.protocol);s=o.request(a,u)}e.timeoutTime&&s.setTimeout(e.timeoutTime,function(){s.abort(),e.streamEnabled||r(new Error("Timeout reached"))}),s.on("error",function(e){r(e)}),e.data&&s.write(e.data),s.end()})},e}()}else{var d=function(e,t){return new Error(e+" "+t.status+" "+t.responseText)};t=function(e,t){return new Promise(function(r,n){var o=t&&t.method||"GET",s=t&&t.body||null,i=t&&t.type||null,a=t&&t.headers||{};e||n(new Error("No url was given"));var u=new XMLHttpRequest;u.open(o,e,!0),s instanceof FormData||"form-data"===i?u.setRequestHeader("Content-Type","multipart/form-data"):null!==s&&"object"==typeof s||"json"===i?("object"==typeof s&&(s=JSON.stringify(s)),u.setRequestHeader("Content-Type","application/json")):u.setRequestHeader("Content-Type",i||"application/x-www-form-urlencoded"),Object.keys(a).forEach(function(e){u.setRequestHeader(e,a[e])}),u.onload=function(){if(u.status>=200&&u.status<400)try{var e=JSON.parse(u.responseText);r(e)}catch(e){r(u.responseText)}else n(d("Server returned:",u))},u.onerror=function(){n(d("Connection error:",u))},u.send(s)})}}var h=function(r,n,o,s){try{if(s=s||{},e){var i=new t(r,n.toUpperCase());return o&&i.body(o),s.headers&&(i.reqHeaders=s.headers),Promise.resolve(i.send().then(function(e){return e&&e.headers?e.headers["content-type"].indexOf("json")>-1?Promise.resolve(e.json()):Promise.resolve(e.text()):Promise.resolve(null)}))}return Promise.resolve(t(r,{method:n.toUpperCase(),body:o,type:s.type,headers:s.headers}))}catch(e){return Promise.reject(e)}};h.get=function(e,t,r){return h(e,"GET",t,r)},h.post=function(e,t,r){return h(e,"POST",t,r)},h.put=function(e,t,r){return h(e,"PUT",t,r)},h.delete=function(e,t,r){return h(e,"DELETE",t,r)},module.exports=h});
